{% load static %}

<div class="col-span-1">
    <div id="strategy-selector" class="border bg-white rounded-2xl p-5 shadow self-start mb-3">
        <!-- Condition builder will be rendered here by condition_builder.js -->
    </div>

    <div class="space-y-4">
        <div>
            <label for="strategy_name" class="block text-sm font-medium text-gray-700">Initial Balance</label>
            <input type="number" id="initial-balance-input" step="100" min="0" max="100000" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="1000">
        </div>
        <div>
            <label for="strategy_name" class="block text-sm font-medium text-gray-700">Token</label>
            <select id="token-select" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                <option value="BTCUSDT">BTCUSDT</option>
                <option value="ETHUSDT">ETHUSDT</option>
                <option value="BNBUSDT">BNBUSDT</option>
            </select>
        </div>
        <div>
            <label for="strategy_name" class="block text-sm font-medium text-gray-700">Timeframe</label>
            <select id="timeframe-select" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                <option value="15m">15m</option>
                <option value="30m">30m</option>
                <option value="1h">1h</option>
                <option value="2h">2h</option>
                <option value="4h">4h</option>
                <option value="1d">1d</option>
            </select>
        </div>
        <div>
            <label for="strategy_name" class="block text-sm font-medium text-gray-700">Candle Amount</label>
            <input type="text" id="candle-amount-input" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="500">
        </div>
    </div>
</div>

<div class="border bg-white rounded-2xl p-5 h-full shadow col-span-2">
    <h2 class="text-lg font-semibold mb-3">Strategy Description</h2>
    <label id="strategy-description-placeholder" class="text-gray-500">Select a strategy to see its description here.</label>
    <div id="strategy-description">
        <!-- Strategy description will be rendered here -->
    </div>
</div>  

<div class="mx-auto border bg-white rounded-2xl p-5 shadow self-start w-1/2 mt-6 col-span-3">
    <span class="relative flex items-center justify-center bg-teal-100 text-teal-700 font-semibold rounded-full capitalize tracking-wide">
        <button id="start-backtest-btn" class="w-full block text-center bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 transition-colors">
            Start Backtest
        </button>
    </span>
</div>


<script type="module">
    import StrategySelector from "/static/backtests/strategy_selector.js";
    import BacktestResults from "/static/backtests/backtest_results.js";

    fetch('/api/strategies/get')
        .then(res => {
            if (res.status === 401) {
            window.location.href = '/login';
            return;
            }
            return res.json();
        })
        .then(data => {
            new StrategySelector('#strategy-selector', data.strategies);
        });

    document.getElementById('start-backtest-btn').addEventListener('click', function(event) {
        event.preventDefault();
        const selectedStrategy = document.querySelector('#strategy-selector .strategy-card-unique');
        const backtestResultsDiv = document.getElementById('backtest-results');
        backtestResultsDiv.innerHTML = '';  
        backtestResultsDiv.classList.add('hidden');
        
        const circleImg = document.getElementById('loading-circle');
        circleImg.classList.remove('hidden');

        if (selectedStrategy) {
            const strategy_id = selectedStrategy.id.split('-').pop();
            const initial_balance = document.getElementById('initial-balance-input').value || 1000;
            const token = document.getElementById('token-select').value;
            const timeframe = document.getElementById('timeframe-select').value;
            const candle_amount = document.getElementById('candle-amount-input').value || 500;
            
            try {
                const response = fetch("/api/backtests/run/ ", {
                    method: "POST",
                    credentials: "same-origin",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1],
                        "Accept": "application/json"
                    },
                    body: JSON.stringify({
                        strategy_id,
                        initial_balance,
                        token,
                        timeframe,
                        candle_amount
                    })
                })
                .then(res => {
                    if (res.status === 401) {
                        window.location.href = '/login';
                        return;
                    }   
                    return res.json();
                })
                .then(data => {
                    const backtestResults = new BacktestResults('#backtest-results', data.result);
                    circleImg.classList.add('hidden');
                });
            } catch (error) {
                console.error("Error running backtest:", error);
            }
        } else {
            alert('Please select a strategy before starting the backtest.');
        }
    });
</script>